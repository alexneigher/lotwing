= render partial: 'shared/maxbox_dependencies'
= javascript_include_tag('vehicle_manager')


.container
  .row.mt-3
    = link_to "Edit details", edit_service_ticket_path(@service_ticket)
  .row.mt-3
    .col-md-4
      %h4 
        Service Ticket For: 
        %span.text-orange= @service_ticket.stock_number
    .col-md-5
      %h4 
        Complete By: 
        - if @service_ticket.complete_by_datetime.present?
          %span.text-orange= @service_ticket.complete_by_datetime.in_time_zone("Pacific Time (US & Canada)").strftime("%d %B %Y %l:%M %p")
    .col-md-3
      %h4 
        Status: 
        %span.text-orange= @service_ticket.status

  %hr

  .row
    .col-8
      .table-responsive.small
        %table.table.table-borderless
          %thead
            %tr
              %th.pb-0.text-orange Date
              %th.pb-0.text-orange Time
              %th.pb-0.text-orange VIN
              %th.pb-0.text-orange Miles
              %th.pb-0.text-orange Year
              %th.pb-0

          %tbody
            %tr
              %td.py-1
                = @service_ticket.created_at.in_time_zone("Pacific Time (US & Canada)").strftime('%m/%d/%Y')
              %td.py-1
                = @service_ticket.created_at.in_time_zone("Pacific Time (US & Canada)").strftime('%l:%M %p')
              %td.py-1
                = @service_ticket.vin
              %td.py-1
                = @service_ticket.mileage
              %td.py-1
                = @service_ticket.year
              %td.py-1 
                - if @service_ticket.vehicle.parking_space&.geo_info
                  / Button trigger modal
                  %a#showVehicleTrigger{"data-target" => "#mapModal", "data-toggle" => "modal", :type => "link", href: ''}
                    %i.fa.fa-map-marker
                    Show Map
            %tr
              %td{colspan: 6}
                = @service_ticket.color
    .col-4
      .card
        .card-body
          %h6.text-center For service department

          .row
            .col-md-6
              = link_to service_ticket_path(@service_ticket, service_ticket: {status: 'In Progress'}), method: :put do
                %btn.btn.btn-primary.btn-block.btn-sm Mark in progress 
            .col-md-6
              = link_to service_ticket_path(@service_ticket, service_ticket: {status: 'Complete'}), method: :put do
                %btn.btn.btn-success.btn-block.btn-sm Mark complete 
  .row
    .col-9
      %h4 Jobs

      - @service_ticket.service_ticket_jobs.each do |job|
        .card.shadow-sm
          .card-body
            .row
              .col-9
                %small.text-muted= "#{job.user.full_name} - #{job.created_at.in_time_zone("Pacific Time (US & Canada)").strftime("%m-%e-%Y")}"
              .col-3.text-right
                = link_to "Add job note", "#", class: 'btn btn-info btn-sm', "aria-controls" => "collapseExample", "aria-expanded" => "false", "data-target" => "#newJobNote", "data-toggle" => "collapse"
                
               
            %h4.pt-0
              = job.title
            %hr
            - job.notes.each do |note|
              .row
                .col-9
                  %p
                    %em.text-blue
                      = "#{note.updated_at.in_time_zone("Pacific Time (US & Canada)").strftime("%m-%e-%Y %l:%M %p")} #{note.user.full_name} wrote:"
                    %br
                    = note.text
                .col-3.text-right
                  - if note.user_id == current_user.id
                    = link_to edit_note_path(note) do
                      %i.fa.fa-pencil
                      edit

            #newJobNote.collapse
              %hr
              .row.mt-4
                .col-6
                  = form_for :note, url: notes_path(), method: :post do |f|
                    = f.hidden_field :service_ticket_job_id, value: job.id
                    = f.text_area :text, rows: 2, placeholder: 'Add note text here', class: 'form-control'
                    = f.submit "Save note", class: 'btn btn-sm btn-primary mt-3 pull-right'
        %hr
                
  .row
    .col-5
      .card.mb-2
        .card-header
          Add new Job
        .card-body
          = form_for :service_ticket_job, url: service_ticket_jobs_path(), method: :post do |f|
            = f.hidden_field :service_ticket_id, value: @service_ticket.id
            = f.hidden_field :user_id, value: current_user.id
            .form-group
              %label Title
              = f.text_area :title, rows: 3, placeholder: 'The blinker fluid is low', class: 'form-control'
            = f.submit "Create Job", class: 'btn btn-sm pull-right btn-primary'


#mapModal.modal{"aria-hidden" => "true", "aria-labelledby" => "exampleModalLabel", :role => "dialog", :tabindex => "-1"}
  .modal-dialog.modal-lg{:role => "document"}
    .modal-content
      .modal-header
        %button.close{"aria-label" => "Close", "data-dismiss" => "modal", :type => "button"}
          %span{"aria-hidden" => "true"} Ã—
      .modal-body
        .row
          #map{ :style => "width: 100%; height: 400px" }        
          .d-none
            //place all dom-dependent info here
            %input#dealership_map_bearing{value: current_user.dealership.map_bearing }
            %input#dealership_map_zoom{value: current_user.dealership.map_zoom }          
      .modal-footer
        %button.btn.btn-secondary{"data-dismiss" => "modal", :type => "button"} Close

- if @service_ticket.vehicle.parking_space&.geo_info
  :javascript
    $(function(){
      $('#mapModal').on('shown.bs.modal', function (event) {
        //the map was just shown, here we can extract just the vehicle in question. and render it to the map
        window.map.resize();
      }); 

      setTimeout(function(){

        layer = window.map.getLayer('singleVehicle');
        if (layer){
          window.map.removeLayer('singleVehicle');
          window.map.removeSource('singleVehicle');
        }
        window.map.addLayer({
          'id': 'singleVehicle',
          'type': 'fill',
          'source': {
              'type': 'geojson',
              "data": {
                        "type": "Feature",
                        "geometry": #{raw(@service_ticket.vehicle.parking_space&.geo_info['geometry'].to_json)}
                      }
          },
          'layout': {},
          'paint': {
            'fill-color': "#{@service_ticket.vehicle.usage_type == "is_used" ? '#66CC00' : '#006699'}",
          }
        });

        map.flyTo({center: #{raw(@service_ticket.vehicle.parking_space&.geo_info['geometry']['coordinates'][0][0].to_json)}});

      }, 100);
    })