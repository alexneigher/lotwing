/ Page Content
= render partial: 'shared/maxbox_dependencies'
= javascript_include_tag('vehicle_manager')
.container-fluid
  .row
    .col-sm-6
      = form_tag search_vehicles_path, method: :get do
        .row
          .col-lg-4
            .form-group
              = text_field_tag "stock_number", params[:stock_number], class: 'form-control-sm form-control', placeholder: 'Search Stock #'
          .col-lg-2
            = submit_tag 'Search', class: 'btn btn-primary btn-sm'
          .col-lg-6.text-right.pt-1
            - grouped = @all_vehicles.group_by(&:usage_type)

            = link_to vehicles_path(filter: {usage_type: 'is_new'}) do
              %span.p-1.rounded.text-white.small{style: "background-color: #{vehicle_usage_type_bg_color('is_new')}"}
                = "New: #{grouped['is_new']&.count || 0}"
            
            = link_to vehicles_path(filter: {usage_type: 'is_used'}) do
              %span.p-1.rounded.ml-1.small{style: "background-color: #{vehicle_usage_type_bg_color('is_used')}"}
                = "Used: #{grouped['is_used']&.count || 0}"

            = link_to vehicles_path(filter: {usage_type: 'lease_return'}) do
              %span.p-1.rounded.ml-1.small{style: "background-color: #{vehicle_usage_type_bg_color('lease_return')}"}
                = "LeaseRT: #{grouped['lease_return']&.count || 0}"

            = link_to vehicles_path(filter: {usage_type: 'loaner'}) do
              %span.p-1.rounded.ml-1.small{style: "background-color: #{vehicle_usage_type_bg_color('loaner')}"}
                = "SrvLn: #{grouped['loaner']&.count || 0}"
                
            = link_to vehicles_path(filter: {usage_type: 'wholesale_unit'}) do
              %span.p-1.rounded.ml-1.small{style: "background-color: #{vehicle_usage_type_bg_color('wholesale_unit')}"}
                = "Whl: #{grouped['wholesale_unit']&.count || 0}"

      .table-responsive.vehicle-table{style: 'max-height: 75vh;'}
        %table.table.table-bordered.table-striped.table-sm
          %thead
            %tr
              %th 
                = link_to vehicles_path(filter:{model: params.dig(:filter,:model)}, sortings: {stock_number: params.dig(:sortings, :stock_number) == 'asc' ? "desc": "asc"}) do
                  Stock #
                  - if params.dig(:sortings, :stock_number) == "asc"
                    %i.fa.fa-sort-up
                  - else
                    %i.fa.fa-sort-down
              %th
                = link_to vehicles_path(filter:{model: params.dig(:filter,:model)}, sortings: {year: params.dig(:sortings, :year) == 'asc' ? "desc": "asc"}) do
                  Year
                  - if params.dig(:sortings, :year) == "asc"
                    %i.fa.fa-sort-up
                  - else
                    %i.fa.fa-sort-down
              %th
                = link_to vehicles_path(filter:{model: params.dig(:filter,:model)}, sortings: {make: params.dig(:sortings, :make) == 'asc' ? "desc": "asc"}) do
                  Make
                  - if params.dig(:sortings, :make) == "asc"
                    %i.fa.fa-sort-up
                  - else
                    %i.fa.fa-sort-down
              %th
                = link_to vehicles_path(filter:{model: params.dig(:filter,:model)}, sortings: {model: params.dig(:sortings, :model) == 'asc' ? "desc": "asc"}) do
                  Model
                  - if params.dig(:sortings, :model) == "asc"
                    %i.fa.fa-sort-up
                  - else
                    %i.fa.fa-sort-down
              %th
                = link_to vehicles_path(filter:{model: params.dig(:filter,:model)}, sortings: {age_in_days: params.dig(:sortings, :age_in_days) == 'asc' ? "desc": "asc"}) do
                  Age
                  - if params.dig(:sortings, :age_in_days) == "asc"
                    %i.fa.fa-sort-up
                  - else
                    %i.fa.fa-sort-down

              
          %tbody.small
            - @filtered_vehicles.each do |vehicle|
              %tr{id: dom_id(vehicle)}
                - if vehicle.current_parking_tag.present?
                  %td{style: "background-color: #{vehicle_usage_type_bg_color(vehicle.usage_type)}" }
                    = link_to vehicle_show_map_path(vehicle), remote: true do
                      = vehicle.stock_number
                - else
                  %td
                    = vehicle.stock_number
                %td
                  = vehicle.year
                %td
                  = link_to vehicle_path(vehicle), onclick: 'show_loading();', remote: true do
                    = vehicle.make
                %th
                  = link_to vehicle_path(vehicle), onclick: 'show_loading();', remote: true do
                    = vehicle.model

                  - if vehicle.open_service_tickets.any?
                    = link_to service_tickets_path(search: {stock_number: vehicle.stock_number}) do
                      .text-danger
                        (OPEN TICKETS)
                %th
                  = vehicle.age_in_days
                  days
               
        = link_to "Add New Vehicle", new_vehicle_path, class: 'btn btn-small btn-primary'
      
    .col-sm-6
      #vehicleDetailContainer
      .row.no-gutters
        - @all_vehicles.where(usage_type: "is_new").group_by(&:model).sort_by{ |key| key }.to_h.each do |model, vehicles|
          .col-4.mt-3.small
            = link_to vehicles_path(filter: {model: model}) do
              %strong #{model} (#{vehicles.count})
            
            - if params.dig(:filter, :model) == model
              - vehicles.group_by(&:trim_level).each do |trim_level, vehicles|
                .mt-2
                  %strong.text-default #{trim_level} (#{vehicles.count})
                  %div
                    - vehicles.each do |vehicle|
                      %span.text-blue= vehicle.stock_number
                      = vehicle.color
                      = number_to_currency vehicle.sale_price
                      %br

      / Modal
      #mapModal.modal{"aria-hidden" => "true", "aria-labelledby" => "exampleModalLabel", :role => "dialog", :tabindex => "-1"}
        .modal-dialog.modal-lg{:role => "document"}
          .modal-content
            .modal-header
              %button.close{"aria-label" => "Close", "data-dismiss" => "modal", :type => "button"}
                %span{"aria-hidden" => "true"} Ã—
            .modal-body
              .row
                #map{ :style => "width: 100%; height: 400px" }        
                .d-none
                  //place all dom-dependent info here
                  %input#dealership_map_bearing{value: current_user.dealership.map_bearing }
                  %input#dealership_map_zoom{value: current_user.dealership.map_zoom }          
            .modal-footer
              %button.btn.btn-secondary{"data-dismiss" => "modal", :type => "button"} Close
      
:javascript
  $(function(){
    $('#mapModal').on('shown.bs.modal', function (event) {
      //the map was just shown, here we can extract just the vehicle in question. and render it to the map
      window.map.resize();
    }); 
  })

  function show_loading(){
    $('#vehicleDetailContainer').html('Loading...')
  }
           
