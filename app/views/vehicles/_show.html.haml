=# @vehicle.inspect
.card.mb-1
  .card-body.pb-0
    - if flash[:success].present?
      .row{id: 'updateFlash'}
        .col-12
          .alert.alert-success.p1y
            = flash[:success]

    .row
      .col-6
        = "#{@vehicle.make} #{@vehicle.model} (#{@vehicle.stock_number}) History"
        %br
        %strong= @vehicle.vin

        .small
          %strong
            Age
            - if @vehicle.data_feed_created?
              - count = @vehicle.age_in_days
            - else
              - count = (DateTime.current.to_date - @vehicle.created_at.to_date).to_i

            = "#{count} days"
      .col-3
        - if @vehicle.open_service_tickets.any?
          = link_to service_tickets_path(search: {stock_number: @vehicle.stock_number}) do
            .text-danger.text-underline
              Open Service Tickets

        - if @vehicle.sales_hold?
          %strong
            Sales Hold

        - if @vehicle.service_hold?
          %strong
            Service Hold

        - if @vehicle.sold?
          %strong
            = @vehicle.sold_status
      .col-3.text-right
        - if @context == "lot_view"
          .close
            x
        %a.small{"data-target" => "#createServiceTicketModal_#{dom_id(@vehicle)}", "data-toggle" => "modal", :type => "link", href: ''}
          Create service ticket
        %br
        = link_to "Hold options", "#", class: 'small', "aria-expanded" => "false", "data-target" => "#holdsContainer_#{dom_id(@vehicle)}", "data-toggle" => "collapse"
    %hr.m00
    = form_for @vehicle, url: vehicle_path(@vehicle), remote: true, method: :put do |f|
      - if current_user.permission_level.in? ["admin", "sales_manager"]
        .row
          .col-3.small
            = link_to "Update stock number", "#", class: 'small', "aria-expanded" => "false", "data-target" => "#stockNumberContainer_#{dom_id(@vehicle)}", "data-toggle" => "collapse"
            .collapse{id: "stockNumberContainer_#{dom_id(@vehicle)}"}
              %label Stock Number
              = f.text_field :stock_number, class: 'form-control form-control-sm'

      .row.mb-3
        .col-2
          %label.small.mb-0 Year
          = f.text_field :year, placeholder: 'Year', class: 'form-control form-control-sm'
        .col-2
          %label.small.mb-0 Make
          = f.text_field :make, placeholder: "Make", class: 'form-control form-control-sm'
        .col-4
          %label.small.mb-0 Model
          = f.text_field :model, placeholder: "Model",  class: 'form-control form-control-sm'
        .col-2
          %label.small.mb-0 Color
          = f.text_field :color, placeholder: "Color", class: 'form-control form-control-sm'
        .col-2
          = f.submit "Update", class: 'btn btn-sm btn-primary btn-block mt-4'
      .row
        .col-12
          .collapse{id: "holdsContainer_#{dom_id(@vehicle)}"}
            %hr.mb-0
            .py-1
              .row
                .col-6
                  %label.small.mb-0
                    Place this vehicle on a Sales Hold
                    = f.check_box :sales_hold, class: 'ml-1'
                  = f.text_area :sales_hold_notes, placeholder: 'Sales Hold Notes', rows: 2, class: 'form-control form-control-sm'
                .col-2
                  .mt-4.text-center
                    %span.p-1.text-white{style:'background-color: #000;'}
                      H
                .col-4.text-right
                  = link_to "Print Hold Tag", vehicle_print_hold_tag_path(@vehicle, format: :pdf), target: "_blank", class: 'btn btn-sm btn-outline-primary mt-4'
            .bg-light.py-2
              .row
                .col-6
                  %label.small.mb-0
                    Place this vehicle on a Service Hold
                    = f.check_box :service_hold, class: 'ml-1'
                  = f.text_area :service_hold_notes, placeholder: 'Service Hold Notes', rows: 2, class: 'form-control form-control-sm'
                .col-2
                  %img.mx-auto.d-block.mt-4{src: "/triangle-24.png"}
                .col-4.text-right
                  = link_to "Print Service Hold Tag", vehicle_print_service_hold_tag_path(@vehicle, format: :pdf), target: "_blank", class: 'btn btn-sm btn-outline-primary mt-4'

    = render partial: 'vehicles/partials/show_recent_events'

    %hr.mt-0
    - grouped_events = @events.group_by(&:event_type)

    %ul.nav.nav-tabs.mt-0{:role => "tablist"}

      - grouped_events.keys.each_with_index do |key, i|
        %li.nav-item
          %a.nav-link{"data-toggle" => "tab", :href => "##{key}_#{dom_id(@vehicle)}", :role => "tab", class: ('active' if i == 0)}
            = "#{key.titleize} (#{grouped_events[key].count})"
    .tab-content.mt-3
      - grouped_events.each do |k, events|
        .tab-pane{:role => "tabpanel", id: "#{k}_#{dom_id(@vehicle)}", class: ('active in' if grouped_events.first[0] == k).to_s }
          %table.table.table-bordered.table-striped.table-sm.mb-0
            %tbody
              - events.sort_by{|s| s.created_at}.reverse.each do |event|
                %tr
                  %td= event.event_type.upcase
                  %td
                    = "Created By #{event.user.full_name} #{event.created_at.in_time_zone("US/Pacific").strftime('%m/%d/%Y')}"
                    %br
                    = event.event_details
                  %td
                    - if event.event_type == "note" && !event.acknowledged?
                      = link_to "clear note", new_event_resolution_path(event), remote: true
                      %br
                      %small
                        %a{"data-target" => "#createNoteTicketModal_#{event.id}", "data-toggle" => "modal", :type => "link", href: ''}
                          create service ticket

                      .modal{id: "createNoteTicketModal_#{event.id}", "aria-hidden" => "true", "aria-labelledby" => "exampleModalLabel", :role => "dialog", :tabindex => "-1"}
                        .modal-dialog.modal-lg{:role => "document"}
                          .modal-content
                            .modal-header
                              %h3 Create Service Ticket
                            = form_for :service_ticket, url: service_tickets_path, method: :post do |f|
                              .modal-body
                                = f.hidden_field :status, value: 'New'
                                = f.hidden_field :created_by_user_id, value: current_user.id
                                .form-group
                                  .row
                                    .col-3
                                      %label Stock Number
                                      = f.text_field :stock_number, value: @vehicle.stock_number, class: 'form-control'
                                    .col-3
                                      %label Make
                                      = f.text_field :make, value: @vehicle.make, class: 'form-control'
                                    .col-3
                                      %label Model
                                      = f.text_field :model, value: @vehicle.model, class: 'form-control'
                                    .col-3
                                      %label Year
                                      = f.text_field :year, value: @vehicle.year, class: 'form-control'
                                .form-group
                                  .row
                                    .col-3
                                      %label Vin
                                      = f.text_field :vin, value: @vehicle.vin, class: 'form-control'
                                    .col-3
                                      %label Color
                                      = f.text_field :color, value: @vehicle.color, class: 'form-control'
                                    .col-3
                                      %label Miles
                                      = f.text_field :mileage, value: @vehicle.mileage, class: 'form-control'


                                .form-group
                                  .row
                                    .col-6
                                      %label Complete By
                                      = f.text_field :complete_by_datetime, value: (@service_ticket&.complete_by_datetime || DateTime.current).in_time_zone("Pacific Time (US & Canada)").strftime("%d %B %Y %l:%M %p %Z"), class: 'form-control'

                                    .col-6
                                      %label Job Title
                                      = text_area_tag "service_ticket_job[title]", event&.event_details, class: 'form-control'
                                      = hidden_field_tag 'service_ticket_job[user_id]', current_user.id

                              .modal-footer
                                = f.submit "Create Service Ticket", class: 'btn btn-primary'


                  %td
                    - event.resolutions.each do |resolution|
                      %div.py-1
                        %strong= "#{resolution.user.full_name}'s action on #{resolution.created_at.in_time_zone("US/Pacific").strftime('%m/%d/%Y')}"
                        %br
                        = resolution.details
  .row.p-2
    .col
      - if @vehicle.parking_space&.geo_info && @context != 'lot_view'
        / Button trigger modal
        = link_to vehicle_show_map_path(@vehicle), remote: true do
          %i.fa.fa-map-marker
          Show Map

    .col
      %a#showVehicleDataFeed{"data-target" => "#vehicleDataFeed", "data-toggle" => "modal", :type => "link", href: ''}
        %i.fa.fa-laptop
        View Data Feed
    .col.text-right
      - if current_user.permission_level == "admin" || current_user.permission_level == "sales_manager"
        = link_to vehicle_path(@vehicle), method: :delete, class: 'text-danger', data: {confirm: 'Are you sure?'} do
          %i.fa.fa-trash
          Delete

/ Data Feed Modal
#vehicleDataFeed.modal{"aria-hidden" => "true", "aria-labelledby" => "exampleModalLabel", :role => "dialog", :tabindex => "-1"}
  .modal-dialog.modal-lg{:role => "document"}
    .modal-content
      .modal-header
        %button.close{"aria-label" => "Close", "data-dismiss" => "modal", :type => "button"}
          %span{"aria-hidden" => "true"} ×
      .modal-body
        .bg-light
          = @vehicle.raw_data_feed_output
      .modal-footer
        %button.btn.btn-secondary{"data-dismiss" => "modal", :type => "button"} Close

.modal{id: "createServiceTicketModal_#{dom_id(@vehicle)}", "aria-hidden" => "true", "aria-labelledby" => "exampleModalLabel", :role => "dialog", :tabindex => "-1"}
  .modal-dialog.modal-lg{:role => "document"}
    .modal-content
      .modal-header
        %h3 Create Service Ticket
      = form_for :service_ticket, url: service_tickets_path, method: :post do |f|
        .modal-body
          = f.hidden_field :status, value: 'New'
          = f.hidden_field :created_by_user_id, value: current_user.id
          .form-group
            .row
              .col-3
                %label Stock Number
                = f.text_field :stock_number, value: @vehicle.stock_number, class: 'form-control'
              .col-3
                %label Make
                = f.text_field :make, value: @vehicle.make, class: 'form-control'
              .col-3
                %label Model
                = f.text_field :model, value: @vehicle.model, class: 'form-control'
              .col-3
                %label Year
                = f.text_field :year, value: @vehicle.year, class: 'form-control'
          .form-group
            .row
              .col-3
                %label Vin
                = f.text_field :vin, value: @vehicle.vin, class: 'form-control'
              .col-3
                %label Color
                = f.text_field :color, value: @vehicle.color, class: 'form-control'
              .col-3
                %label Miles
                = f.text_field :mileage, value: @vehicle.mileage, class: 'form-control'


          .form-group
            .row
              .col-6
                %label Complete By
                = f.text_field :complete_by_datetime, value: (@service_ticket&.complete_by_datetime || DateTime.current).in_time_zone("Pacific Time (US & Canada)").strftime("%d %B %Y %l:%M %p %Z"), class: 'form-control'
              .col-6
                %label Job Title
                = text_area_tag "service_ticket_job[title]",nil, class: 'form-control'
                = hidden_field_tag 'service_ticket_job[user_id]', current_user.id

        .modal-footer
          = f.submit "Create Service Ticket", class: 'btn btn-primary'

